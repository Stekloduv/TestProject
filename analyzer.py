from rapidfuzz import fuzz

# Словник типів робіт
WORK_TYPES = {
    "Комп'ютерна діагностика": [
        "комп'ютерна діагностика", "компютерна діагностика", "діагностика комп’ютерна",
        "комп діагностика", "зробити діагностику комп’ютером", "провести комп’ютерну діагностику"
    ],

    "Заміна оливи ДВЗ + масляний фільтр": [
        "заміна оливи", "поміняти оливу", "масляний фільтр", "фільтр оливи", "заміна оливи двз",
        "олива двигуна", "олива моторна", "моторна олива", "міняємо оливу", "масло двигуна",
        "масло моторне", "заміна масла", "масляний фильтр", "фільтр масла"
    ],

    "Комплексна діагностика": [
        "комплексна діагностика", "повна діагностика", "загальна діагностика", "все перевірити"
    ],

    "Ендоскопія": [
        "ендоскопія", "ендоскоп", "перевірка ендоскопом", "діагностика ендоскопом"
    ],

    "Заміна повітряного фільтра ДВЗ": [
        "повітряний фільтр", "фільтр повітря", "заміна повітряного фільтра", "повітряний фільтр двз",
        "фільтр двигуна", "заміна фільтра двигуна", "заміна фільтра повітря", "повітряний фильтр"
    ],

    "Заміна фільтра салону в салонному відділенні": [
        "фільтр салону", "салонний фільтр", "заміна фільтра салону", "салонний фильтр", "фільтр в салоні"
    ],

    "Заміна сайлентблоку": [
        "сайлентблок", "сайлент блок", "сайленблок", "заміна сайлентблоку", "поміняти сайлентблок",
        "сайлентблоки", "сайлент блоки"
    ],

    "Зняття / встановлення важіля": [
        "зняття важіля", "встановлення важіля", "зняття/встановлення важіля", "зняти важіль",
        "поставити важіль", "заміна важіля", "важіль підвіски"
    ],

    "Заміна еластичної муфти карданного валу": [
        "еластична муфта", "муфта кардана", "заміна муфти карданного валу", "карданний вал",
        "заміна муфти карданного", "задня муфта", "муфта еластична"
    ],

    "Слюсарні роботи": [
        "слюсарні роботи", "слюсарка", "роботи по підвісці", "підвіска", "слюсарний ремонт"
    ],

    "Діагностика підвіски (НЕ ВИКОРИСТОВУЄМ) ВИКОРИСТОВУЄМ КОМПЛЕКСНУ": [
        "діагностика підвіски", "перевірка підвіски", "огляд підвіски"
    ],

    "Зняття / встановлення важіля пред.": [
        "зняття важіля переднього", "встановлення важіля переднього", "передній важіль", "зняти передній важіль"
    ],

    "Заміна амортизатора переднього": [
        "амортизатор передній", "заміна амортизатора переднього", "аморт передній", "міняти передній амортизатор"
    ],

    "Заміна оливи АКПП": [
        "олива акпп", "масло акпп", "заміна оливи акпп", "заміна масла акпп", "олива коробки",
        "заміна оливи коробки", "масло коробки", "олива в коробці"
    ],

    "Мийка / чистка деталі": [
        "мийка деталі", "чистка деталі", "помити деталь", "почистити деталь", "очистка"
    ],

    "Зняття / встановлення повітряного патрубка": [
        "повітряний патрубок", "зняття патрубка", "встановлення патрубка", "зняти патрубок",
        "поставити патрубок", "патрубок повітряний"
    ],

    "Заміна охолоджувальної рідини": [
        "охолоджувальна рідина", "заміна охолоджувальної рідини", "антифриз", "поміняти антифриз",
        "тосол", "заміна тосолу", "злити антифриз"
    ],

    "Заміна гальмівної рідини з прокачкою": [
        "гальмівна рідина", "прокачка гальмівної рідини", "заміна гальмівної рідини", "прокачати гальма",
        "заміна тормозної рідини", "тормозна рідина", "прокачка тормозів"
    ],

    "Заміна оливи в зд. редукторі": [
        "олива задній редуктор", "заміна оливи редуктора", "масло редуктора", "редуктор задній",
        "олива в редукторі", "заміна масла редуктора"
    ],

    "Кодування опцій": [
        "кодування опцій", "код опцій", "перекодування", "активація функцій", "налаштування опцій"
    ],

    "Заміна амортизатора зд.": [
        "амортизатор задній", "заміна амортизатора заднього", "аморт задній", "міняти задній амортизатор"
    ],

    "Заміна гальмівних дисків та колодок пред.": [
        "гальмівні диски передні", "гальмівні колодки передні", "заміна дисків та колодок передніх",
        "передні колодки", "передні гальма", "міняти гальма спереду", "заміна передніх колодок"
    ]
}

# Список небажаних фраз
BAD_PHRASES = [
    "не знаю", "чекайте", "мені байдуже", "що ви хочете", "не можу допомогти"
]


def analyze_text(text, threshold=80):
    """
    Аналізує текст:
    - Перевіряє на наявність небажаних фраз і формує рейтинг.
    - Визначає типи робіт, згаданих у тексті.

    Повертає: rating, comment, list_of_found_work_types
    """
    text_lower = text.lower()

    # 1️⃣ Перевірка на небажані фрази
    issues = [phrase for phrase in BAD_PHRASES if phrase.lower() in text_lower]
    rating = 10
    if issues:
        rating -= len(issues)
    comment = "✅ Все добре" if rating > 7 else f"❌ Проблеми: {', '.join(issues)}"
    if issues:
        comment = f"\033[91m{comment}\033[0m"

    # 2️⃣ Пошук типів робіт
    found_work = []
    for work, keywords in WORK_TYPES.items():
        for kw in keywords:
            score = fuzz.partial_ratio(kw.lower(), text_lower)
            if score >= threshold:
                found_work.append(work)
                break  # знайшли ключ → переходимо до наступної роботи

    return rating, comment, found_work